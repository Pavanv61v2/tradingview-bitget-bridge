<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
        }
        .buy-bg {
            background-color: rgba(40, 167, 69, 0.1);
        }
        .sell-bg {
            background-color: rgba(220, 53, 69, 0.1);
        }
        .buy-text {
            color: #28a745;
        }
        .sell-text {
            color: #dc3545;
        }
        .stats-card {
            transition: all 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .table td, .table th {
            vertical-align: middle;
        }
        .failed {
            background-color: rgba(220, 53, 69, 0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-robot"></i> TradingView-Bitget Bridge
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- First row of stats -->
        <div class="row">
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Trades</h5>
                        <h2 id="total-trades">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Successful</h5>
                        <h2 id="successful-trades" class="buy-text">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Failed</h5>
                        <h2 id="failed-trades" class="sell-text">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Success Rate</h5>
                        <h2 id="success-rate">0%</h2>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Performance metrics row -->
        <div class="row mt-3">
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Avg Trade Size</h5>
                        <h2 id="avg-trade-size">0 USDT</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Largest Buy</h5>
                        <h2 id="largest-buy" class="buy-text">0 USDT</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Largest Sell</h5>
                        <h2 id="largest-sell" class="sell-text">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Profit/Loss</h5>
                        <h2 id="profit-loss">0 USDT</h2>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Recent Trades</span>
                        <button id="refresh-btn" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Symbol</th>
                                        <th>Action</th>
                                        <th>Amount</th>
                                        <th>Price</th>
                                        <th>Order ID</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="trades-table-body">
                                    <!-- Trade rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Trades by Symbol
                    </div>
                    <div class="card-body">
                        <canvas id="symbolChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Buy/Sell Ratio
                    </div>
                    <div class="card-body">
                        <canvas id="actionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Timeline Chart Section -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        Trade Activity Timeline
                    </div>
                    <div class="card-body">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="mt-5 mb-3 text-center text-muted">
            <p>Last updated: <span id="last-updated">Never</span></p>
        </footer>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Function to load and display trade data
        async function loadTradeData() {
            try {
                const response = await fetch('trade_history.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const trades = await response.json();
                displayTrades(trades);
                updateStats(trades);
                updateCharts(trades);
                updateTimelineChart(trades); // Added timeline chart update
                
                document.getElementById('last-updated').textContent = new Date().toLocaleString();
            } catch (error) {
                console.error('Error loading trade data:', error);
                document.getElementById('last-updated').textContent = 'Error loading data. Try refreshing.';
            }
        }
        
        // Function to display trades in the table
        function displayTrades(trades) {
            const tableBody = document.getElementById('trades-table-body');
            tableBody.innerHTML = '';
            
            // Sort trades by timestamp (newest first)
            trades.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Display up to the last 50 trades
            const recentTrades = trades.slice(0, 50);
            
            recentTrades.forEach(trade => {
                const row = document.createElement('tr');
                
                if (trade.status === 'failed') {
                    row.classList.add('failed');
                }
                
                const timestamp = new Date(trade.timestamp).toLocaleString();
                
                // Prepare amount and price text
                let amountText = '';
                let priceText = '';
                
                if (trade.action === 'buy') {
                    // Use filled amounts if available, otherwise use original order size
                    const amount = trade.filledBaseVolume || trade.orderSize;
                    const symbol = trade.symbol ? trade.symbol.replace('USDT', '') : '';
                    amountText = `${amount} ${symbol}`;
                    
                    if (trade.usdtEquivalent) {
                        amountText += ` (${trade.usdtEquivalent} USDT)`;
                    } else if (trade.filledQuoteVolume) {
                        amountText += ` (${trade.filledQuoteVolume} USDT)`;
                    }
                } else if (trade.action === 'sell') {
                    // Use filled amounts if available, otherwise use original order size
                    const amount = trade.filledBaseVolume || trade.orderSize;
                    const symbol = trade.symbol ? trade.symbol.replace('USDT', '') : '';
                    amountText = `${amount} ${symbol}`;
                    
                    if (trade.usdtEquivalent) {
                        amountText += ` (${trade.usdtEquivalent} USDT)`;
                    }
                }
                
                // Price text
                if (trade.price) {
                    priceText = `${trade.price} USDT`;
                } else {
                    priceText = 'N/A';
                }
                
                row.innerHTML = `
                    <td>${timestamp}</td>
                    <td>${trade.symbol || 'N/A'}</td>
                    <td class="${trade.action === 'buy' ? 'buy-text' : 'sell-text'}">
                        ${trade.action === 'buy' ? 'BUY' : 'SELL'}
                    </td>
                    <td>${amountText}</td>
                    <td>${priceText}</td>
                    <td>${trade.orderId || 'N/A'}</td>
                    <td>
                        ${trade.status === 'success' 
                            ? '<span class="badge bg-success">Success</span>' 
                            : '<span class="badge bg-danger">Failed</span>'}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Function to update statistics
        function updateStats(trades) {
            const totalTrades = trades.length;
            const successfulTrades = trades.filter(t => t.status === 'success').length;
            const failedTrades = trades.filter(t => t.status === 'failed').length;
            const successRate = totalTrades > 0 ? ((successfulTrades / totalTrades) * 100).toFixed(1) : 0;
            
            document.getElementById('total-trades').textContent = totalTrades;
            document.getElementById('successful-trades').textContent = successfulTrades;
            document.getElementById('failed-trades').textContent = failedTrades;
            document.getElementById('success-rate').textContent = `${successRate}%`;
            
            // Calculate new metrics
            const successfulBuyTrades = trades.filter(t => t.status === 'success' && t.action && t.action.toLowerCase() === 'buy');
            const successfulSellTrades = trades.filter(t => t.status === 'success' && t.action && t.action.toLowerCase() === 'sell');
            
            // Average trade size (for buys only, as they're in USDT)
            let avgTradeSize = 0;
            if (successfulBuyTrades.length > 0) {
                const totalBuySize = successfulBuyTrades.reduce((sum, trade) => {
                    const size = parseFloat(trade.filledQuoteVolume || trade.usdtEquivalent || trade.orderSize || 0);
                    return sum + size;
                }, 0);
                avgTradeSize = (totalBuySize / successfulBuyTrades.length).toFixed(2);
            }
            document.getElementById('avg-trade-size').textContent = `${avgTradeSize} USDT`;
            
            // Largest buy
            let largestBuy = 0;
            if (successfulBuyTrades.length > 0) {
                largestBuy = Math.max(...successfulBuyTrades.map(t => 
                    parseFloat(t.filledQuoteVolume || t.usdtEquivalent || t.orderSize || 0)
                )).toFixed(2);
            }
            document.getElementById('largest-buy').textContent = `${largestBuy} USDT`;
            
            // Largest sell (this will be in the coin amount, not USDT)
            let largestSell = 0;
            let largestSellCoin = '';
            if (successfulSellTrades.length > 0) {
                const largestSellTrade = successfulSellTrades.reduce((max, trade) => {
                    const size = parseFloat(trade.usdtEquivalent || 0);
                    return size > parseFloat(max.usdtEquivalent || 0) ? trade : max;
                }, { usdtEquivalent: '0' });
                
                largestSell = parseFloat(largestSellTrade.usdtEquivalent || 0).toFixed(2);
                largestSellCoin = 'USDT';
            }
            document.getElementById('largest-sell').textContent = largestSell + (largestSellCoin ? ` ${largestSellCoin}` : '');
            
            // Most traded symbol
            const symbolCounts = {};
            trades.forEach(trade => {
                if (trade.symbol) {
                    symbolCounts[trade.symbol] = (symbolCounts[trade.symbol] || 0) + 1;
                }
            });
            
            let mostTraded = 'N/A';
            let maxCount = 0;
            for (const [symbol, count] of Object.entries(symbolCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    mostTraded = symbol;
                }
            }
            document.getElementById('most-traded').textContent = mostTraded;
            
            // Calculate profit/loss 
            let totalProfitLoss = 0;
            let profitLossPercentage = 0;

            // Track total USDT spent on buys and received from sells
            const totalBuyUsdt = trades
                .filter(t => t.status === 'success' && t.action === 'buy')
                .reduce((sum, trade) => sum + (parseFloat(trade.filledQuoteVolume || trade.usdtEquivalent || trade.orderSize || 0)), 0);

            const totalSellUsdt = trades
                .filter(t => t.status === 'success' && t.action === 'sell')
                .reduce((sum, trade) => sum + (parseFloat(trade.usdtEquivalent || 0)), 0);

            // Calculate profit/loss
            totalProfitLoss = totalSellUsdt - totalBuyUsdt;

            // Calculate percentage
            if (totalBuyUsdt > 0) {
                profitLossPercentage = (totalProfitLoss / totalBuyUsdt * 100).toFixed(2);
            }

            // Update UI elements
            const profitLossElement = document.getElementById('profit-loss');
            profitLossElement.textContent = `${totalProfitLoss.toFixed(2)} USDT`;
            profitLossElement.className = totalProfitLoss >= 0 ? 'buy-text' : 'sell-text';

            // Add percentage if meaningful
            if (totalBuyUsdt > 0) {
                profitLossElement.textContent += ` (${profitLossPercentage}%)`;
            }
        }
        
        // Function to update charts
        function updateCharts(trades) {
            updateSymbolChart(trades);
            updateActionChart(trades);
        }
        
        // Function to update symbol distribution chart
        function updateSymbolChart(trades) {
            const symbolCounts = {};
            
            trades.forEach(trade => {
                if (trade.symbol) {
                    symbolCounts[trade.symbol] = (symbolCounts[trade.symbol] || 0) + 1;
                }
            });
            
            const labels = Object.keys(symbolCounts);
            const data = Object.values(symbolCounts);
            
            // Generate random colors
            const backgroundColors = labels.map(() => 
                `rgba(${Math.floor(Math.random() * 200)}, ${Math.floor(Math.random() * 200)}, ${Math.floor(Math.random() * 200)}, 0.6)`
            );
            
            const ctx = document.getElementById('symbolChart').getContext('2d');
            
            // Safely destroy previous chart if it exists
            if (window.symbolChart && typeof window.symbolChart.destroy === 'function') {
                window.symbolChart.destroy();
            } else if (window.symbolChart) {
                window.symbolChart = null;
            }
            
            window.symbolChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Trade Distribution by Symbol'
                        }
                    }
                }
            });
        }
        
        // Function to update buy/sell ratio chart
        function updateActionChart(trades) {
            const buyTrades = trades.filter(t => t.action && t.action.toLowerCase() === 'buy').length;
            const sellTrades = trades.filter(t => t.action && t.action.toLowerCase() === 'sell').length;
            
            const ctx = document.getElementById('actionChart').getContext('2d');
            
            // Safely destroy previous chart if it exists
            if (window.actionChart && typeof window.actionChart.destroy === 'function') {
                window.actionChart.destroy();
            } else if (window.actionChart) {
                window.actionChart = null;
            }
            
            window.actionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Buy', 'Sell'],
                    datasets: [{
                        data: [buyTrades, sellTrades],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.6)',
                            'rgba(220, 53, 69, 0.6)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Buy vs Sell Orders'
                        }
                    }
                }
            });
        }
        
        // Function to update timeline chart
        function updateTimelineChart(trades) {
            // Sort trades by timestamp
            const sortedTrades = [...trades].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Prepare data for chart
            const labels = sortedTrades.map(trade => {
                const date = new Date(trade.timestamp);
                return date.toLocaleString(undefined, { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            });
            
            // Create datasets for buys and sells with USDT values where available
            const buyData = sortedTrades.map(trade => 
                trade.action && trade.action.toLowerCase() === 'buy' ? 
                    parseFloat(trade.filledQuoteVolume || trade.usdtEquivalent || trade.orderSize || 0) : null
            );
            
            const sellData = sortedTrades.map(trade => 
                trade.action && trade.action.toLowerCase() === 'sell' ? 
                    parseFloat(trade.usdtEquivalent || 0) : null
            );
            
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            // Safely destroy previous chart if it exists
            if (window.timelineChart && typeof window.timelineChart.destroy === 'function') {
                window.timelineChart.destroy();
            } else if (window.timelineChart) {
                window.timelineChart = null;
            }
            
            window.timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Buy Orders (USDT)',
                            data: buyData,
                            borderColor: 'rgba(40, 167, 69, 1)',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: false
                        },
                        {
                            label: 'Sell Orders (USDT)',
                            data: sellData,
                            borderColor: 'rgba(220, 53, 69, 1)',
                            backgroundColor: 'rgba(220, 53, 69, 0.2)',
                            pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (USDT)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Trading Activity Over Time'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const trade = sortedTrades[index];
                                    const datasetLabel = context.dataset.label;
                                    
                                    if (trade.action && trade.action.toLowerCase() === 'buy') {
                                        const amount = trade.filledBaseVolume || trade.orderSize;
                                        const usdtValue = trade.filledQuoteVolume || trade.usdtEquivalent;
                                        const price = trade.price || 'N/A';
                                        const symbol = trade.symbol ? trade.symbol.replace('USDT', '') : '';
                                        return `${datasetLabel}: ${amount} ${symbol} @ ${price} USDT (${usdtValue} USDT)`;
                                    } else if (trade.action && trade.action.toLowerCase() === 'sell') {
                                        const amount = trade.filledBaseVolume || trade.orderSize;
                                        const usdtValue = trade.usdtEquivalent || 0;
                                        const price = trade.price || 'N/A';
                                        const symbol = trade.symbol ? trade.symbol.replace('USDT', '') : '';
                                        return `${datasetLabel}: ${amount} ${symbol} @ ${price} USDT (${usdtValue} USDT)`;
                                    }
                                    return datasetLabel;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadTradeData);
        
        // Refresh button handler
        document.getElementById('refresh-btn').addEventListener('click', loadTradeData);
        
        // Auto-refresh every 5 minutes
        setInterval(loadTradeData, 5 * 60 * 1000);
    </script>
</body>
</html>
